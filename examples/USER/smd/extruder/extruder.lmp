# create flow by heating and cooling
variable        l0 equal 1.0 # initial particle lattice spacing
variable        rho equal 1.0e-6 # mass density ulsph
variable        h equal 2.5*${l0} # SPH kernel diameter
variable        c0 equal 1.0 # speed of sound for ulsph
variable        contact_stiffness equal 100*${c0}^2*${rho} # contact force amplitude
variable        skin equal 2*${l0} # Verlet list range
variable        vol_one equal ${l0}^3 # initial particle volume for 2d simulation
variable        cr0 equal ${l0}/2
variable        dtcfl equal 0.1*${l0}/${c0}

units		si
dimension       3
boundary        f f f
atom_style      smd
comm_style      tiled
neighbor        ${skin} bin
neigh_modify    every 5 delay 0 check yes exclude type 2 2 one 10000 page 100000
comm_modify     vel yes
newton          off
atom_modify     map hash sort 1000 5.0

# create simulation box, a container, and a ulsph column
region          box block -100 100 -100 100 -10 30 units box
create_box      2 box

lattice         sc ${l0}
region          particles cylinder z 0 0 2.5 6 20 units box
create_atoms    1 region particles
#create_atoms    1 single 20 20 20 units box
group           particles type 1

set             group all volume ${vol_one}
set             group all diameter ${h}
set             group all density ${rho}
set             group all meso_rho ${rho}
set             group particles contact_radius ${cr0}
pair_style      hybrid/overlay ulsph smd/tri_surface 1.0
pair_coeff      1 1 ulsph *COMMON ${rho} ${c0} 1.0 1 &
		*EOS_TAIT 2 &
	        *END
#pair_style      hybrid/overlay smd/hertz 1.0 smd/tri_surface 1.0
#pair_coeff      1 1 smd/hertz ${contact_stiffness}
pair_coeff      2 2 none
pair_coeff      1 2 smd/tri_surface ${contact_stiffness} 

velocity        particles set 0 0 -0.1 units box


fix             stl_surface_fix1 all smd/wall_surface extruder_refined.stl 2 65535
fix             stl_surface_fix2 all smd/wall_surface housing_new.stl 2 65536
run 0
group           extruder molecule 65535
group           housing molecule 65536

thermo          10
thermo_style    custom step dt ke pe lx ly lz
thermo_modify   lost warn

#dump            dump_stl_extruder extruder smd/stl 10 dump_extruder.*.stl
#dump_modify     dump_stl_extruder first yes

#dump            dump_stl_housing housing smd/stl 9999999 dump_housing.*.stl
#dump_modify     dump_stl_housing first yes

#dump            dump_vtk particles smd/vtk 10 dump_particles.*.vtk
#dump_modify     dump_vtk first yes

compute         rho particles smd/rho
compute         F all smd/triangle_vertices 

dump            dump_custom particles custom 10 dump.LAMMPS id type mol x y z vx vy vz c_rho
dump_modify     dump_custom first yes

dump            dump_extruder extruder custom 10 dump_extruder.LAMMPS id type mol x y z &
                c_F[1] c_F[2] c_F[3] c_F[4] c_F[5] c_F[6] c_F[7] c_F[8] c_F[9]
dump_modify     dump_extruder first yes


dump            dump_housing housing custom 999999999 dump_housing.LAMMPS id type mol x y z &
                c_F[1] c_F[2] c_F[3] c_F[4] c_F[5] c_F[6] c_F[7] c_F[8] c_F[9]
dump_modify     dump_housing first yes

run 0

change_box      all boundary s s s

balance         0.9 rcb
#balance 1.0 shift x 5 1.05

timestep        0.1
fix             dtfix all smd/adjust_dt 0.1
fix             integration_fix particles smd/integrate_ulsph limit_velocity 1.0 adjust_radius 1.2
fix             gfix particles gravity -9.81e-3 vector 0 0 1
fix             boundary_fix extruder smd/move_tri_surf *ROTATE 0 0 0 -1 0 0 100
fix             bfix all balance 500 0.9 rcb
#fix 2 all balance 1000 1.05 shift x 10 1.05
fix             1 particles viscous 0.00000001

run             10000



